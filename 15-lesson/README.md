# –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–µ—Ç—Ä–∏–∫–∏-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  - [üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](#-—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)
  - [üéØ –¶–µ–ª—å](#-—Ü–µ–ª—å)
  - [1. –ó–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ ClickHouse](#1-–∑–∞–ø—Ä–æ—Å—ã-–¥–ª—è-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞-—Ä–µ—Å—É—Ä—Å–æ–≤-clickhouse)
    - [üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º](#-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-cpu-–ø–æ-–∑–∞–ø—Ä–æ—Å–∞–º)
    - [üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º](#-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–ø–∞–º—è—Ç–∏-–ø–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
    - [üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞](#-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–¥–∏—Å–∫–æ–≤–æ–≥–æ-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞)
    - [üî∏ –°–∞–º—ã–µ —Ç—è–∂—ë–ª—ã–µ –∑–∞–ø—Ä–æ—Å—ã (CPU + –ø–∞–º—è—Ç—å)](#-—Å–∞–º—ã–µ-—Ç—è–∂—ë–ª—ã–µ-–∑–∞–ø—Ä–æ—Å—ã-cpu--–ø–∞–º—è—Ç—å)
  - [2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞](#2-—Å–æ–∑–¥–∞–Ω–∏–µ-—Ç–∞–±–ª–∏—Ü—ã-–¥–ª—è-—Ö—Ä–∞–Ω–µ–Ω–∏—è-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
  - [3. –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞](#3-–≤—Å—Ç–∞–≤–∫–∞-–¥–∞–Ω–Ω—ã—Ö-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
  - [üõ† –ß—Ç–æ –Ω—É–∂–Ω–æ:](#-—á—Ç–æ-–Ω—É–∂–Ω–æ)

---

## üéØ –¶–µ–ª—å

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å **–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ClickHouse** —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ **–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** ‚Äî CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫. –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤.

---

## 1. –ó–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ ClickHouse

### üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º

```sql
SELECT
    query,
    sum(read_rows) AS total_rows,
    sum(read_bytes) / 1048576 AS read_mb,
    round(avg(query_duration_ms), 2) AS avg_ms
FROM system.query_log
WHERE event_date >= today() - 1
  AND type = 'QueryFinish'
GROUP BY query
ORDER BY total_rows DESC
LIMIT 10;
```

### üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

```sql
SELECT
    user,
    round(avg(memory_usage) / 1048576, 2) AS avg_memory_mb
FROM system.query_log
WHERE event_date >= today() - 1
  AND type = 'QueryFinish'
GROUP BY user
ORDER BY avg_memory_mb DESC;
```

### üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

```sql
SELECT
    table,
    database,
    round(sum(bytes_on_disk) / 1048576, 2) AS size_mb
FROM system.parts
GROUP BY table, database
ORDER BY size_mb DESC;
```

### üî∏ –°–∞–º—ã–µ —Ç—è–∂—ë–ª—ã–µ –∑–∞–ø—Ä–æ—Å—ã (CPU + –ø–∞–º—è—Ç—å)

```sql
SELECT
    query,
    round(avg(query_duration_ms), 2) AS avg_duration_ms,
    round(avg(memory_usage)/1048576, 2) AS avg_memory_mb
FROM system.query_log
WHERE event_date >= today() - 1
  AND type = 'QueryFinish'
GROUP BY query
ORDER BY avg_duration_ms DESC
LIMIT 10;
```

---

## 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```sql
CREATE TABLE IF NOT EXISTS monitoring.query_metrics
(
    event_time     DateTime DEFAULT now(),
    metric_name    String,
    metric_value   Float64,
    metric_label   String
)
ENGINE = MergeTree()
ORDER BY event_time;
```

---

## 3. –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–ü—Ä–∏–º–µ—Ä –≤—Ä—É—á–Ω—É—é:

```sql
INSERT INTO monitoring.query_metrics (metric_name, metric_value, metric_label)
VALUES
('avg_memory_mb', 315.2, 'user1'),
('disk_usage_mb', 20500, 'table_orders'),
('query_duration_ms', 2400, 'SELECT * FROM logs');
```

---

## üõ† –ß—Ç–æ –Ω—É–∂–Ω–æ:

1. **–°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É** —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (`CREATE TABLE ...`)
2. **–ó–∞–ø—É—Å—Ç–∏ SQL-–∑–∞–ø—Ä–æ—Å—ã** –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 1
3. **–í—Å—Ç–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** –≤ —Å–≤–æ—é —Ç–∞–±–ª–∏—Ü—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
4. **–û—Ç–∫—Ä–æ–π Web UI** ClickHouse (`http://localhost:8123`) (`http://localhost:8123/dashboard`)
5. **–í—ã–ø–æ–ª–Ω–∏ –∑–∞–ø—Ä–æ—Å**: `SELECT * FROM monitoring.query_metrics`
6. **–°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç** ‚Üí –ø—Ä–∏–∫—Ä–µ–ø–∏ –∫–∞–∫ `dashboard_screenshot.png` –∏–ª–∏ –≤—Å—Ç–∞–≤—å –ø—Ä—è–º–æ –≤ README

---
